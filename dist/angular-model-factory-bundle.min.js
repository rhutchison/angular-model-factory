/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v0.4.0 - 2015-05-26
 * @link https://github.com/swimlane/model-factory
 * @author Austin McDaniel <amcdaniel2@gmail.com>, Juri Strumpflohner <juri.strumpflohner@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(e){"use strict";function r(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function i(e,t){Object.defineProperty(this,"kind",{value:e,enumerable:!0}),t&&t.length&&Object.defineProperty(this,"path",{value:t,enumerable:!0})}function f(e,t,n){f.super_.call(this,"E",e),Object.defineProperty(this,"lhs",{value:t,enumerable:!0}),Object.defineProperty(this,"rhs",{value:n,enumerable:!0})}function l(e,t){l.super_.call(this,"N",e),Object.defineProperty(this,"rhs",{value:t,enumerable:!0})}function u(e,t){u.super_.call(this,"D",e),Object.defineProperty(this,"lhs",{value:t,enumerable:!0})}function s(e,t,n){s.super_.call(this,"A",e),Object.defineProperty(this,"index",{value:t,enumerable:!0}),Object.defineProperty(this,"item",{value:n,enumerable:!0})}function h(e,t,n){var a=e.slice((n||t)+1||e.length);return e.length=0>t?e.length+t:t,e.push.apply(e,a),e}function c(t,n,a,r,i,p,o){i=i||[];var b=i.slice(0);if("undefined"!=typeof p){if(r&&r(b,p))return;b.push(p)}var d=typeof t,k=typeof n;if("undefined"===d)"undefined"!==k&&a(new l(b,n));else if("undefined"===k)a(new u(b,t));else if(d!==k)a(new f(b,t,n));else if(t instanceof Date&&n instanceof Date&&t-n!==0)a(new f(b,t,n));else if("object"===d&&null!==t&&null!==n){if(o=o||[],o.indexOf(t)<0){if(o.push(t),Array.isArray(t)){var v;t.length;for(v=0;v<t.length;v++)v>=n.length?a(new s(b,v,new u(e,t[v]))):c(t[v],n[v],a,r,b,v,o);for(;v<n.length;)a(new s(b,v,new l(e,n[v++])))}else{var m=Object.keys(t),g=Object.keys(n);m.forEach(function(i,f){var l=g.indexOf(i);l>=0?(c(t[i],n[i],a,r,b,i,o),g=h(g,l)):c(t[i],e,a,r,b,i,o)}),g.forEach(function(t){c(e,n[t],a,r,b,t,o)})}o.length=o.length-1}}else t!==n&&("number"===d&&isNaN(t)&&isNaN(n)||a(new f(b,t,n)))}function p(t,n,a,r){return r=r||[],c(t,n,function(e){e&&r.push(e)},a),r.length?r:e}function o(e,t,n){if(n.path&&n.path.length){var r,a=e[t],i=n.path.length-1;for(r=0;i>r;r++)a=a[n.path[r]];switch(n.kind){case"A":o(a[n.path[r]],n.index,n.item);break;case"D":delete a[n.path[r]];break;case"E":case"N":a[n.path[r]]=n.rhs}}else switch(n.kind){case"A":o(e[t],n.index,n.item);break;case"D":e=h(e,t);break;case"E":case"N":e[t]=n.rhs}return e}function b(e,t,n){if(e&&t&&n&&n.kind){for(var a=e,r=-1,i=n.path.length-1;++r<i;)"undefined"==typeof a[n.path[r]]&&(a[n.path[r]]="number"==typeof n.path[r]?new Array:{}),a=a[n.path[r]];switch(n.kind){case"A":o(a[n.path[r]],n.index,n.item);break;case"D":delete a[n.path[r]];break;case"E":case"N":a[n.path[r]]=n.rhs}}}function d(e,t,n){if(n.path&&n.path.length){var r,a=e[t],i=n.path.length-1;for(r=0;i>r;r++)a=a[n.path[r]];switch(n.kind){case"A":d(a[n.path[r]],n.index,n.item);break;case"D":a[n.path[r]]=n.lhs;break;case"E":a[n.path[r]]=n.lhs;break;case"N":delete a[n.path[r]]}}else switch(n.kind){case"A":d(e[t],n.index,n.item);break;case"D":e[t]=n.lhs;break;case"E":e[t]=n.lhs;break;case"N":e=h(e,t)}return e}function k(e,t,n){if(e&&t&&n&&n.kind){var r,i,a=e;for(i=n.path.length-1,r=0;i>r;r++)"undefined"==typeof a[n.path[r]]&&(a[n.path[r]]={}),a=a[n.path[r]];switch(n.kind){case"A":d(a[n.path[r]],n.index,n.item);break;case"D":a[n.path[r]]=n.lhs;break;case"E":a[n.path[r]]=n.lhs;break;case"N":delete a[n.path[r]]}}}function v(e,t,n){if(e&&t){var a=function(a){(!n||n(e,t,a))&&b(e,t,a)};c(e,t,a)}}var t,n,a=[];t="object"==typeof global&&global?global:"undefined"!=typeof window?window:{},n=t.DeepDiff,n&&a.push(function(){"undefined"!=typeof n&&t.DeepDiff===p&&(t.DeepDiff=n,n=e)}),r(f,i),r(l,i),r(u,i),r(s,i),Object.defineProperties(p,{diff:{value:p,enumerable:!0},observableDiff:{value:c,enumerable:!0},applyDiff:{value:v,enumerable:!0},applyChange:{value:b,enumerable:!0},revertChange:{value:k,enumerable:!0},isConflict:{get:function(){return"undefined"!=typeof n},enumerable:!0},noConflict:{value:function(){return a&&(a.forEach(function(e){e()}),a=null),p},enumerable:!0}}),"undefined"!=typeof module&&module&&"object"==typeof exports&&exports&&module.exports===exports?module.exports=p:t.DeepDiff=p}(),function(global,factory){"function"==typeof define&&define.amd?define([],factory):"undefined"!=typeof module&&module.exports?module.exports=factory():global.UriTemplate=factory()}(this,function(){function notReallyPercentEncode(string){return encodeURI(string).replace(/%25[0-9][0-9]/g,function(doubleEncoded){return"%"+doubleEncoded.substring(3)})}function uriTemplateSubstitution(spec){var modifier="";uriTemplateGlobalModifiers[spec.charAt(0)]&&(modifier=spec.charAt(0),spec=spec.substring(1));var separator="",prefix="",shouldEscape=!0,showVariables=!1,trimEmptyString=!1;"+"==modifier?shouldEscape=!1:"."==modifier?(prefix=".",separator="."):"/"==modifier?(prefix="/",separator="/"):"#"==modifier?(prefix="#",shouldEscape=!1):";"==modifier?(prefix=";",separator=";",showVariables=!0,trimEmptyString=!0):"?"==modifier?(prefix="?",separator="&",showVariables=!0):"&"==modifier&&(prefix="&",separator="&",showVariables=!0);for(var varNames=[],varList=spec.split(","),varSpecs=[],varSpecMap={},i=0;i<varList.length;i++){var varName=varList[i],truncate=null;if(-1!=varName.indexOf(":")){var parts=varName.split(":");varName=parts[0],truncate=parseInt(parts[1])}for(var suffices={};uriTemplateSuffices[varName.charAt(varName.length-1)];)suffices[varName.charAt(varName.length-1)]=!0,varName=varName.substring(0,varName.length-1);var varSpec={truncate:truncate,name:varName,suffices:suffices};varSpecs.push(varSpec),varSpecMap[varName]=varSpec,varNames.push(varName)}var subFunction=function(valueFunction){for(var result="",startIndex=0,i=0;i<varSpecs.length;i++){var varSpec=varSpecs[i],value=valueFunction(varSpec.name);if(null==value||Array.isArray(value)&&0==value.length||"object"==typeof value&&0==Object.keys(value).length)startIndex++;else if(result+=i==startIndex?prefix:separator||",",Array.isArray(value)){showVariables&&(result+=varSpec.name+"=");for(var j=0;j<value.length;j++)j>0&&(result+=varSpec.suffices["*"]?separator||",":",",varSpec.suffices["*"]&&showVariables&&(result+=varSpec.name+"=")),result+=shouldEscape?encodeURIComponent(value[j]).replace(/!/g,"%21"):notReallyPercentEncode(value[j])}else if("object"==typeof value){showVariables&&!varSpec.suffices["*"]&&(result+=varSpec.name+"=");var first=!0;for(var key in value)first||(result+=varSpec.suffices["*"]?separator||",":","),first=!1,result+=shouldEscape?encodeURIComponent(key).replace(/!/g,"%21"):notReallyPercentEncode(key),result+=varSpec.suffices["*"]?"=":",",result+=shouldEscape?encodeURIComponent(value[key]).replace(/!/g,"%21"):notReallyPercentEncode(value[key])}else showVariables&&(result+=varSpec.name,trimEmptyString&&""==value||(result+="=")),null!=varSpec.truncate&&(value=value.substring(0,varSpec.truncate)),result+=shouldEscape?encodeURIComponent(value).replace(/!/g,"%21"):notReallyPercentEncode(value)}return result},guessFunction=function(stringValue,resultObj){if(prefix){if(stringValue.substring(0,prefix.length)!=prefix)return null;stringValue=stringValue.substring(prefix.length)}if(1==varSpecs.length&&varSpecs[0].suffices["*"]){for(var varSpec=varSpecs[0],varName=varSpec.name,arrayValue=varSpec.suffices["*"]?stringValue.split(separator||","):[stringValue],hasEquals=shouldEscape&&-1!=stringValue.indexOf("="),i=1;i<arrayValue.length;i++){var stringValue=arrayValue[i];hasEquals&&-1==stringValue.indexOf("=")&&(arrayValue[i-1]+=(separator||",")+stringValue,arrayValue.splice(i,1),i--)}for(var i=0;i<arrayValue.length;i++){var stringValue=arrayValue[i];shouldEscape&&-1!=stringValue.indexOf("=")&&(hasEquals=!0);for(var innerArrayValue=stringValue.split(","),j=0;j<innerArrayValue.length;j++)shouldEscape&&(innerArrayValue[j]=decodeURIComponent(innerArrayValue[j]));1==innerArrayValue.length?arrayValue[i]=innerArrayValue[0]:arrayValue[i]=innerArrayValue}if(showVariables||hasEquals){for(var objectValue=resultObj[varName]||{},j=0;j<arrayValue.length;j++){var innerValue=stringValue;if("string"==typeof arrayValue[j]){var stringValue=arrayValue[j],innerVarName=stringValue.split("=",1)[0],stringValue=stringValue.substring(innerVarName.length+1);innerValue=stringValue}else{var stringValue=arrayValue[j][0],innerVarName=stringValue.split("=",1)[0],stringValue=stringValue.substring(innerVarName.length+1);arrayValue[j][0]=stringValue,innerValue=arrayValue[j]}void 0!==objectValue[innerVarName]?Array.isArray(objectValue[innerVarName])?objectValue[innerVarName].push(innerValue):objectValue[innerVarName]=[objectValue[innerVarName],innerValue]:objectValue[innerVarName]=innerValue}1==Object.keys(objectValue).length&&void 0!==objectValue[varName]?resultObj[varName]=objectValue[varName]:resultObj[varName]=objectValue}else void 0!==resultObj[varName]?Array.isArray(resultObj[varName])?resultObj[varName]=resultObj[varName].concat(arrayValue):resultObj[varName]=[resultObj[varName]].concat(arrayValue):1!=arrayValue.length||varSpec.suffices["*"]?resultObj[varName]=arrayValue:resultObj[varName]=arrayValue[0]}else{for(var arrayValue=1==varSpecs.length?[stringValue]:stringValue.split(separator||","),specIndexMap={},i=0;i<arrayValue.length;i++){for(var firstStarred=0;firstStarred<varSpecs.length-1&&i>firstStarred&&!varSpecs[firstStarred].suffices["*"];firstStarred++);if(firstStarred!=i){for(var lastStarred=varSpecs.length-1;lastStarred>0&&varSpecs.length-lastStarred<arrayValue.length-i&&!varSpecs[lastStarred].suffices["*"];lastStarred--);varSpecs.length-lastStarred!=arrayValue.length-i?specIndexMap[i]=firstStarred:specIndexMap[i]=lastStarred}else specIndexMap[i]=i}for(var i=0;i<arrayValue.length;i++){var stringValue=arrayValue[i],innerArrayValue=stringValue.split(",");if(showVariables){var stringValue=innerArrayValue[0],varName=stringValue.split("=",1)[0],stringValue=stringValue.substring(varName.length+1);innerArrayValue[0]=stringValue;var varSpec=varSpecMap[varName]||varSpecs[0]}else var varSpec=varSpecs[specIndexMap[i]],varName=varSpec.name;for(var j=0;j<innerArrayValue.length;j++)shouldEscape&&(innerArrayValue[j]=decodeURIComponent(innerArrayValue[j]));(showVariables||varSpec.suffices["*"])&&void 0!==resultObj[varName]?Array.isArray(resultObj[varName])?resultObj[varName]=resultObj[varName].concat(innerArrayValue):resultObj[varName]=[resultObj[varName]].concat(innerArrayValue):1!=innerArrayValue.length||varSpec.suffices["*"]?resultObj[varName]=innerArrayValue:resultObj[varName]=innerArrayValue[0]}}};return subFunction.varNames=varNames,{prefix:prefix,substitution:subFunction,unSubstitution:guessFunction}}function UriTemplate(template){if(!(this instanceof UriTemplate))return new UriTemplate(template);for(var parts=template.split("{"),textParts=[parts.shift()],prefixes=[],substitutions=[],unSubstitutions=[],varNames=[];parts.length>0;){var part=parts.shift(),spec=part.split("}")[0],remainder=part.substring(spec.length+1),funcs=uriTemplateSubstitution(spec);substitutions.push(funcs.substitution),unSubstitutions.push(funcs.unSubstitution),prefixes.push(funcs.prefix),textParts.push(remainder),varNames=varNames.concat(funcs.substitution.varNames)}this.fill=function(valueFunction){for(var result=textParts[0],i=0;i<substitutions.length;i++){var substitution=substitutions[i];result+=substitution(valueFunction),result+=textParts[i+1]}return result},this.fromUri=function(substituted){for(var result={},i=0;i<textParts.length;i++){var part=textParts[i];if(substituted.substring(0,part.length)!==part)return void 0;if(substituted=substituted.substring(part.length),i>=textParts.length-1){if(""==substituted)break;return void 0}for(var nextPart=textParts[i+1],offset=i;;){if(offset==textParts.length-2){var endPart=substituted.substring(substituted.length-nextPart.length);if(endPart!==nextPart)return void 0;var stringValue=substituted.substring(0,substituted.length-nextPart.length);substituted=endPart}else if(nextPart){var nextPartPos=substituted.indexOf(nextPart),stringValue=substituted.substring(0,nextPartPos);substituted=substituted.substring(nextPartPos)}else if(prefixes[offset+1]){var nextPartPos=substituted.indexOf(prefixes[offset+1]),stringValue=substituted.substring(0,nextPartPos);substituted=substituted.substring(nextPartPos)}else{if(textParts.length>offset+2){offset++,nextPart=textParts[offset+1];continue}var stringValue=substituted;substituted=""}break}unSubstitutions[i](stringValue,result)}return result},this.varNames=varNames,this.template=template}var uriTemplateGlobalModifiers={"+":!0,"#":!0,".":!0,"/":!0,";":!0,"?":!0,"&":!0},uriTemplateSuffices={"*":!0};return UriTemplate.prototype={toString:function(){return this.template},fillFromObject:function(obj){return this.fill(function(varName){return obj[varName]})}},UriTemplate}),function(global,factory){"function"==typeof define&&define.amd?define(["angular","uri-templates"],factory):"undefined"!=typeof module&&module.exports?module.exports=factory():global.ModelFactory=factory(angular,UriTemplate)}(this,function(angular,UriTemplate){var module=angular.module("modelFactory",[]),forEach=angular.forEach,extend=angular.extend,copy=angular.copy,instanceKeywords=["$$array","$save","$destroy","$pending","$rollback","$diff","$update","$commit","$copy"],staticKeywords=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],extendDeep=function(dst){return forEach(arguments,function(obj){obj!==dst&&forEach(obj,function(value,key){-1===instanceKeywords.indexOf(key)&&(dst[key]?angular.isArray(dst[key])?dst[key].concat(value.filter(function(v){var vv=-1!==dst[key].indexOf(v);return vv&&extendDeep(vv,v),vv})):angular.isObject(dst[key])?extendDeep(dst[key],value):dst[key]=value:angular.isFunction(dst[key])||(dst[key]=value))})}),dst},shallowClearAndCopy=function(src,dst){dst=dst||{},forEach(dst,function(value,key){src.hasOwnProperty(key)||"$"===key.charAt(0)||delete dst[key]});for(var key in src)src.hasOwnProperty(key)&&"$"!==key.charAt(0)&&(angular.isObject(src[key])&&!angular.isArray(src[key])?dst[key]=shallowClearAndCopy(src[key],dst[key]):dst[key]=src[key]);return dst};module.provider("$modelFactory",function(){var provider=this;provider.defaultOptions={prefix:"",pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:void 0,afterRequest:void 0,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},"delete":{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},provider.$get=["$rootScope","$http","$q","$log","$cacheFactory",function($rootScope,$http,$q,$log,$cacheFactory){function modelFactory(url,options){function ModelCollection(value){value=value||[],value.forEach(function(v,i){null!==v&&void 0!==v&&(value[i]=wrapAsNewModelInstance(v,value))});var __oldPush=value.push;return value.push=function(){for(var args=Array.prototype.slice.call(arguments),i=0;i<args.length;i++)args[i]=wrapAsNewModelInstance(args[i],value);__oldPush.apply(value,args)},options.list&&extend(value,options.list),value}function Model(value){var instance=this,commits=[];value=value||{},forEach(options.defaults,function(v,k){void 0===value[k]&&("function"==typeof v?value[k]=v(value):value[k]=v)}),forEach(options.map,function(v,k){typeof v===Model||typeof v===ModelCollection?value[k]=new v(value[k]):"function"==typeof v?value[k]=v(value[k],value):(value[k]=value[v],delete value[v])}),forEach(options.actions,function(v,k){"$"===k[0]&&(instance[k]=function(){return Model.$buildRequest(k,v,instance)})}),extend(instance,value),extend(instance,copy(options.instance)),instance.$save=function(){var actionType=instance[options.pk]?"update":"post",promise=Model[actionType](this);return instance.$pending=!0,promise.then(function(value){instance.$pending=!1,value&&instance.$update(value);var broadcastName="post"===actionType?"created":"updated";$rootScope.$broadcast(prettyName+"-"+broadcastName,instance),commits.push(angular.toJson(instance))},function(){instance.$pending=!1}),promise},instance.$destroy=function(){var promise=Model["delete"](this);return instance.$pending=!0,promise.then(function(){instance.$pending=!1;var arr=instance.$$array;arr&&arr.splice(arr.indexOf(instance),1),$rootScope.$broadcast(prettyName+"-destroyed",instance)},function(){instance.$pending=!1}),promise},instance.$diff=function(){return DeepDiff.deep(old,instance,function(path,key){return"$"===key[0]})},instance.$commit=function(){return commits.push(angular.toJson(instance)),instance},instance.$rollback=function(version){var prevCommit=commits[version||commits.length-1];return instance.$update(JSON.parse(prevCommit)),instance},instance.$update=function(n){return shallowClearAndCopy(n,instance),instance},instance.$copy=function(){var rawData=angular.toJson(this);return new Model(angular.fromJson(rawData))},instance.$commit()}var promiseTracker={},nameSplit=url.split("/"),prettyName=nameSplit[nameSplit.length-1];options=extendDeep({},copy(provider.defaultOptions),options);var wrapAsNewModelInstance=function(rawObj,arrayInst){var inst=rawObj.constructor===Model?rawObj:new Model(rawObj);return inst.$$array=arrayInst,inst};return Model.$cache=$cacheFactory(url),forEach(options.actions,function(v,k){"base"!==k&&"$"!==k[0]&&(Model[k]=function(){var args=Array.prototype.slice.call(arguments);return Model.$buildRequest.apply(this,[k,v].concat(args))})}),Model.$buildRequest=function(action,param,data,extras){var clone=copy(options.actions.base);extend(clone,copy(param)),clone.cache===!0&&(clone.cache=Model.$cache),clone.method=clone.method||"GET";var uri=options.prefix?options.prefix+"/":"";if(clone.override)uri=clone.url;else if(uri+=url,clone.url&&(uri+="/"+clone.url),uri=Model.$url(uri,data,clone.method),("get"===action||"post"===action||"update"===action||"delete"===action)&&(uri+="/{"+options.pk+"}"),"GET"===clone.method&&(angular.isString(data)||angular.isNumber(data))){var obj={};obj[options.pk]=data,data=obj,extras&&(data.param=extras,uri+="{?param*}")}else"GET"===clone.method&&angular.isObject(data)&&(data={param:data},uri+="{?param*}");return clone.url=Model.$url(uri,data,clone.method),"delete"!==action&&"DELETE"!==clone.method&&(clone.data=data),Model.$call(clone)},Model.$call=function(params){var signature=params.method+":"+params.url;if(promiseTracker[signature])return promiseTracker[signature];var def=$q.defer();return promiseTracker[signature]=def.promise,params.data=copy(params.data),params.beforeRequest&&params.beforeRequest(params),params.data=Model.$strip(params.data),$http(params).success(function(response){if(params.afterRequest){var transform=params.afterRequest(response);transform&&(response=transform)}params.invalidateCache&&Model.$cache.removeAll(),response?params.wrap?params.isArray?def.resolve(new Model.List(response)):def.resolve(new Model(response)):def.resolve(response):def.resolve(),promiseTracker[signature]=void 0}).error(function(response){promiseTracker[signature]=void 0,def.reject(response)}),def.promise},Model.$url=function(u,params,method){var uri=new UriTemplate(u||url).fill(function(variableName){var resolvedVariable=params[variableName];return resolvedVariable?("GET"===method&&delete params[variableName],resolvedVariable):null});return options.stripTrailingSlashes&&(uri=uri.replace(/\/+$/,"")||"/"),uri},Model.$strip=function(args){return args&&"object"==typeof args&&forEach(args,function(v,k){instanceKeywords.indexOf(k)>-1&&delete args[k]}),args},forEach(options,function(v,k){-1===staticKeywords.indexOf(k)&&(Model[k]=v)}),Model.List=ModelCollection,Model}return modelFactory}]})});